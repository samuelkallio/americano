<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pelaajat — Americano</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="common.js"></script>
  <script>
    // UI-callback jota common.js kutsuu live päivityksissä
    window.updatePlayersUI = function(players){
      const tbl = document.getElementById('playerTable');
      // sort descending by wins then points
      players = (players || []).slice().sort((a,b)=>(b.wins||0)-(a.wins||0) || (b.totalPoints||0)-(a.totalPoints||0));
      let html = `<tr><th>Nimi</th><th>Voitot</th><th>Pisteet</th><th>Pelit</th><th>Tauot</th><th>Pysyvä tauko</th><th>Poista</th></tr>`;
      players.forEach(p=>{
        html += `<tr>
          <td>${p.name}</td>
          <td>${p.wins||0}</td>
          <td>${p.totalPoints||0}</td>
          <td>${p.games||0}</td>
          <td>${p.byeCount||0}</td>
          <td>
            <input type="checkbox" ${p.permanentBreak ? "checked" : ""} onchange="togglePermanent('${p.id}',this.checked)" />
          </td>
          <td>
            <button onclick="deletePlayer('${p.id}')">❌</button>
          </td>
        </tr>`;
      });
      tbl.innerHTML = html;
    }

    async function togglePermanent(id, checked){
      try {
        await window.updatePlayerInDB(id, { permanentBreak: !!checked });
        showBanner(checked ? 'Pelaaja tauolla' : 'Pelaaja takaisin peleihin','success');
      } catch(e){ showBanner('Virhe','error'); }
    }

    async function deletePlayer(id){
      if(!confirm('Poistetaanko pelaaja pysyvästi?')) return;
      try {
        await window.deletePlayerFromDB(id);
        showBanner('Pelaaja poistettu','success');
      } catch(e){ showBanner('Poisto epäonnistui','error'); }
    }

    // UUSI: Monirivinen pelaajien lisäys
    async function addPlayersBulk(){
      const area = document.getElementById('bulkPlayerArea');
      const namesRaw = area.value.trim();
      if(!namesRaw) return showBanner('Anna pelaajien nimet','error');
      const names = namesRaw.split('\n').map(x => x.trim()).filter(x => !!x);
      if(!names.length) return showBanner('Anna pelaajien nimet','error');
      let added = 0, errors = 0;
      for(const name of names){
        try {
          await window.addPlayerToDB({ name, wins:0, totalPoints:0, games:0, byeCount:0, permanentBreak:false });
          added++;
        } catch(e) {
          errors++;
        }
      }
      if(added) showBanner(`Lisättiin ${added} pelaajaa!`, 'success');
      if(errors) showBanner(`${errors} pelaajaa ei voitu lisätä`, 'error');
      area.value = "";
    }

    async function clearAll(){
      if(!confirm('Poistetaanko kaikki pelaajat ja kierrokset (varoitus: tämä poistaa pysyvästi pilvitiedot)?')) return;
      try {
        const players = window.store?.players || [];
        const rounds = window.store?.rounds || [];
        for(const p of players) await window.deletePlayerFromDB(p.id);
        for(const r of rounds) await window.deleteRoundFromDB(r.id);
        showBanner('Kaikki poistettu','success');
      } catch(e){
        showBanner('Poisto epäonnistui','error'); console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      if(window.startLiveSync) window.startLiveSync();
      if(window.store && window.store.players) window.updatePlayersUI(window.store.players);
    });
  </script>
</head>
<body>
  <div id="banner" class="banner"></div>
  <div class="container card">
    <h1>Pelaajat</h1>
    <table id="playerTable"></table>

    <div style="margin-top:24px;max-width:400px;margin-left:auto;margin-right:auto;">
      <label for="bulkPlayerArea"><b>Lisää pelaajia rivittäin (yksi nimi/rivi):</b></label>
      <textarea id="bulkPlayerArea" rows="5" style="width:100%;margin-top:6px;margin-bottom:8px;resize:vertical"></textarea>
      <div>
        <button onclick="addPlayersBulk()">➕ Lisää kaikki nimet</button>
        <button onclick="clearAll()">🗑️ Tyhjennä kaikki</button>
      </div>
    </div>
    <div style="margin-top:24px;text-align:center;">
      <button onclick="location.href='index.html'">Etusivu</button>
      <button onclick="location.href='rounds.html'">🎾 Kierros</button>
      <button onclick="location.href='results.html'">📜 Tulokset</button>
      <button onclick="location.href='players.html'" class="active">👥</button>
    </div>
  </div>
  <footer>
    <button onclick="location.href='index.html'">🏠</button>
    <button onclick="location.href='players.html'" class="active">👥</button>
    <button onclick="location.href='rounds.html'">🎾</button>
    <button onclick="location.href='results.html'">📜</button>
  </footer>
</body>
</html>
