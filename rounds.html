<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kierrokset — Americano</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="common.js"></script>
  <script>
    // Listaa kierrokset ja näytä valittu kierros
    let selectedRoundId = null;

    window.updateRoundsUI = function(rounds){
      const listEl = document.getElementById('roundsList');
      if(!listEl) return;
      let html = '';
      if(!rounds || !rounds.length) {
        html = '<div class="small">Ei kierroksia</div>';
      } else {
        rounds.forEach((r, idx) => {
          html += `<button 
            style="margin:3px;padding:5px 12px;${selectedRoundId===r.id?'background:#eee':''}" 
            onclick="selectRound('${r.id}')">
            ${new Date(r.date).toLocaleString()}${idx===0?' <b>(uusin)</b>':''}
          </button>`;
        });
      }
      listEl.innerHTML = html;

      // Jos valittua kierrosta ei ole, näytä uusin
      if(!selectedRoundId && rounds && rounds.length) {
        selectedRoundId = rounds[0].id;
      }
      showRound(selectedRoundId);
    };

    window.selectRound = function(id){
      selectedRoundId = id;
      showRound(id);
    };

    window.updatePlayersUI = function(players){
      window.playersLocal = players;
      // kun pelaajat päivittyy, päivitä valittu kierros
      if(selectedRoundId) showRound(selectedRoundId);
    };

    function getNameById(id){
      const p = (window.playersLocal||[]).find(x=>x.id===id);
      return p ? p.name : '?';
    }

    function showRound(roundId){
      const tbl = document.getElementById('roundTable');
      const byesEl = document.getElementById('byesList');
      const round = (window.store?.rounds || []).find(r=>r.id===roundId);
      document.getElementById('currentRoundId').value = roundId || '';
      if(!round){ tbl.innerHTML = '<div class="small">Ei kierrosta valittuna</div>'; byesEl.innerHTML=''; return; }
      let html = '';
      (round.courts || []).slice().sort((a,b)=> b.courtNumber - a.courtNumber).forEach(c=>{
        const homeNames = (c.home||[]).map(getNameById).join(' & ');
        const awayNames = (c.away||[]).map(getNameById).join(' & ');
        html += `<tr>
          <td><strong>K${c.courtNumber}</strong></td>
          <td>${homeNames} <input type="number" id="sH${c.courtNumber}" min="0" max="${window.store?.settings?.winPoints||11}" value="${c.scoreHome||0}" style="width:90px"></td>
          <td>${awayNames} <input type="number" id="sA${c.courtNumber}" min="0" max="${window.store?.settings?.winPoints||11}" value="${c.scoreAway||0}" style="width:90px"></td>
        </tr>`;
      });
      tbl.innerHTML = html;
      const byes = (round.byes||[]).map(id=>getNameById(id));
      byesEl.innerHTML = `<strong>Tauolla:</strong> ${byes.length ? byes.join(', ') : 'Ei ketään'}`;
    }

    function validateScore(sH, sA, wp){
      if(Number.isNaN(sH) || Number.isNaN(sA)) return false;
      if(sH < 0 || sA < 0 || sH > wp || sA > wp) return false;
      // one must equal wp and be greater than other
      if((sH === wp && sH > sA) || (sA === wp && sA > sH)) return true;
      return false;
    }

    async function saveResults(){
      const roundId = document.getElementById('currentRoundId').value;
      if(!roundId) return showBanner('Ei kierrosta valittuna','error');
      // find round in store
      const round = (window.store?.rounds || []).find(r=>r.id===roundId);
      if(!round) return showBanner('Kierrosta ei löydy','error');
      const wp = window.store?.settings?.winPoints || 11;
      // validate all courts first
      for(const c of round.courts || []){
        const sH = Number(document.getElementById(`sH${c.courtNumber}`).value || 0);
        const sA = Number(document.getElementById(`sA${c.courtNumber}`).value || 0);
        if(!validateScore(sH, sA, wp)){
          return showBanner(`Virhe kenttä ${c.courtNumber}: tarkista tulokset`, 'error');
        }
      }
      // apply scores and save round
      for(const c of round.courts || []){
        c.scoreHome = Number(document.getElementById(`sH${c.courtNumber}`).value || 0);
        c.scoreAway = Number(document.getElementById(`sA${c.courtNumber}`).value || 0);
      }
      try {
        await window.saveRoundToDB(round);
        // recompute players on server
        await window.recomputeAndSavePlayers();
        showBanner('✅ Tulokset tallennettu', 'success');
        // auto create new round
        setTimeout(()=>{ window.autoCreateRound(); }, 800);
      } catch(e){
        console.error(e); showBanner('Tallennus epäonnistui','error');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      if(window.startLiveSync) window.startLiveSync();
      // render immediate if local store present
      if(window.store?.rounds?.length) window.updateRoundsUI(window.store.rounds);
    });
  </script>
</head>
<body>
  <div id="banner" class="banner"></div>
  <div class="container card">
    <h1>Kierrokset</h1>
    <div id="roundsList" style="margin-bottom:18px"></div>
    <input type="hidden" id="currentRoundId" value="">
    <div id="byesList" class="small" style="margin-bottom:8px"></div>
    <table id="roundTable"></table>
    <div style="text-align:center;margin-top:8px"><button onclick="saveResults()">💾 Tallenna tulokset</button></div>
  </div>

  <footer>
    <button onclick="location.href='index.html'">⚙️</button>
    <button onclick="location.href='players.html'">👥</button>
    <button onclick="location.href='rounds.html'" class="active">🎾</button>
    <button onclick="location.href='results.html'">📜</button>
  </footer>
</body>
</html>
